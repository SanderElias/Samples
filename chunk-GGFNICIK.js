import{a as U,b as A}from"./chunk-7RIJD2NO.js";import{a as x}from"./chunk-QGBLPN5Q.js";import{b as M}from"./chunk-X5V44QYE.js";import{c as N,e as k,g as $,h as O,j as P}from"./chunk-XK4SX6X4.js";import{d as L,h as b}from"./chunk-BHC7RI4T.js";import{Aa as _,Rc as v,S as R,aa as g,d as S,fa as m,p as D,qa as I,wa as c,za as T}from"./chunk-AAKWIQ7G.js";import{a as C}from"./chunk-C6Q5SG76.js";function F(o){return Object.entries(o).reduce((i,[t,e])=>{let s=t.split("."),r=s.pop(),n=i;for(let a=0;a<s.length;a++){let h=s[a],l=s[a+1]??r;n=n[h]??=O(l)?[]:{}}return n[r]=e,i},{})}var w=(o,i)=>{let t=x(o),e=x(i),s={};for(let r in t)t[r]!==e[r]&&(s[r]=e[r]??t[r]);for(let r in e)r in t||(s[r]=e[r]);return F(s)};var d=function(o,i){if(!(this instanceof d))return new d(o,i);this.url=o,i=i||{},this.headers=i.headers||{},this.payload=i.payload!==void 0?i.payload:"",this.method=i.method||this.payload&&"POST"||"GET",this.withCredentials=!!i.withCredentials,this.debug=!!i.debug,this.autoReconnect=i.autoReconnect!==void 0?i.autoReconnect:!1,this.reconnectDelay=i.reconnectDelay!==void 0?i.reconnectDelay:3e3,this.maxRetries=i.maxRetries!==void 0?i.maxRetries:null,this.retryCount=0,this.reconnectTimer=null,this.useLastEventId=i.useLastEventId!==void 0?i.useLastEventId:!0,this.FIELD_SEPARATOR=":",this.listeners={},this.xhr=null,this.readyState=d.INITIALIZING,this.progress=0,this.chunk="",this.lastEventId="",this.addEventListener=function(t,e){this.listeners[t]===void 0&&(this.listeners[t]=[]),this.listeners[t].indexOf(e)===-1&&this.listeners[t].push(e)},this.removeEventListener=function(t,e){if(this.listeners[t]===void 0)return;let s=[];this.listeners[t].forEach(function(r){r!==e&&s.push(r)}),s.length===0?delete this.listeners[t]:this.listeners[t]=s},this.dispatchEvent=function(t){if(!t)return!0;this.debug&&console.debug(t),t.source=this;let e="on"+t.type;return this.hasOwnProperty(e)&&(this[e].call(this,t),t.defaultPrevented)?!1:this.listeners[t.type]?this.listeners[t.type].every(function(s){return s(t),!t.defaultPrevented}):!0},this._markClosed=function(){if(this.xhr=null,this.progress=0,this.chunk="",this._setReadyState(d.CLOSED),this.autoReconnect){if(this.maxRetries!==null&&this.retryCount>=this.maxRetries){this.debug&&console.debug(`SSE max retries (${this.maxRetries}) reached, stopping reconnection attempts`),this.autoReconnect=!1,this.close();return}this.reconnectTimer&&clearTimeout(this.reconnectTimer),this.debug&&console.debug(`SSE will attempt to reconnect in ${this.reconnectDelay}ms (attempt ${this.retryCount+1}${this.maxRetries?"/"+this.maxRetries:""})`),this.reconnectTimer=setTimeout(()=>{this.reconnectTimer=null,this.retryCount++,this.stream()},this.reconnectDelay)}},this._setReadyState=function(t){let e=new CustomEvent("readystatechange");e.readyState=t,this.readyState=t,this.dispatchEvent(e)},this._onStreamFailure=function(t){let e=new CustomEvent("error");e.responseCode=t.currentTarget.status,e.data=t.currentTarget.response,this.dispatchEvent(e),this._markClosed()},this._onStreamAbort=function(){this.dispatchEvent(new CustomEvent("abort")),this._markClosed()},this._onStreamProgress=function(t){if(!this.xhr)return;if(this.xhr.status<200||this.xhr.status>=300){this._onStreamFailure(t);return}this.retryCount=0;let e=this.xhr.responseText.substring(this.progress);this.progress+=e.length;let s=(this.chunk+e).split(/(\r\n\r\n|\r\r|\n\n)/g),r=s.pop();s.forEach(function(n){n.trim().length>0&&this.dispatchEvent(this._parseEventChunk(n))}.bind(this)),this.chunk=r},this._onStreamLoaded=function(t){this._onStreamProgress(t),this.dispatchEvent(this._parseEventChunk(this.chunk)),this.chunk="",this._markClosed()},this._parseEventChunk=function(t){if(!t||t.length===0)return null;this.debug&&console.debug(t);let e={id:null,retry:null,data:null,event:null};if(t.split(/\n|\r\n|\r/).forEach(function(r){let n=r.indexOf(this.FIELD_SEPARATOR),a,h;if(n>0){let l=r[n+1]===" "?2:1;a=r.substring(0,n),h=r.substring(n+l)}else if(n<0)a=r,h="";else return;a in e&&(a==="data"&&e[a]!==null?e.data+=`
`+h:e[a]=h)}.bind(this)),e.data===null)return null;e.id!==null&&(this.lastEventId=e.id);let s=new CustomEvent(e.event||"message");return s.id=e.id,s.data=e.data||"",s.lastEventId=this.lastEventId,s},this._onReadyStateChange=function(){if(this.xhr&&this.xhr.readyState===XMLHttpRequest.HEADERS_RECEIVED){let t={},e=this.xhr.getAllResponseHeaders().trim().split(`\r
`);for(let r of e){let[n,...a]=r.split(":"),h=a.join(":").trim();t[n.trim().toLowerCase()]=t[n.trim().toLowerCase()]||[],t[n.trim().toLowerCase()].push(h)}let s=new CustomEvent("open");s.responseCode=this.xhr.status,s.headers=t,this.dispatchEvent(s),this._setReadyState(d.OPEN)}},this.stream=function(){if(!this.xhr){this._setReadyState(d.CONNECTING),this.xhr=new XMLHttpRequest,this.xhr.addEventListener("progress",this._onStreamProgress.bind(this)),this.xhr.addEventListener("load",this._onStreamLoaded.bind(this)),this.xhr.addEventListener("readystatechange",this._onReadyStateChange.bind(this)),this.xhr.addEventListener("error",this._onStreamFailure.bind(this)),this.xhr.addEventListener("abort",this._onStreamAbort.bind(this)),this.xhr.open(this.method,this.url);for(let t in this.headers)this.xhr.setRequestHeader(t,this.headers[t]);this.useLastEventId&&this.lastEventId.length>0&&this.xhr.setRequestHeader("Last-Event-ID",this.lastEventId),this.xhr.withCredentials=this.withCredentials,this.xhr.send(this.payload)}},this.close=function(){this.readyState!==d.CLOSED&&(this.reconnectTimer&&(clearTimeout(this.reconnectTimer),this.reconnectTimer=null),this.autoReconnect=!1,this.xhr.abort())},(i.start===void 0||i.start)&&this.stream()};d.INITIALIZING=-1;d.CONNECTING=0;d.OPEN=1;d.CLOSED=2;typeof exports<"u"&&(exports.SSE=d);var B=(()=>{class o{constructor(){this.shown=c(!1),this.message=c(""),this.template=c(void 0),this.title=c("Sorry, something went wrong"),this.type=c("error"),this.dismissButtonText=c("dismiss"),this.showTemplate=t=>{this.template.set(t),this.shown.set(!0)},this.show=({message:t="",title:e=this.title(),type:s=this.type(),dismissButtonText:r=this.dismissButtonText()})=>{this.message.set(t),e&&this.title.set(e),this.type.set(s),this.dismissButtonText.set(r),this.shown.set(!0)},this.close=()=>{this.shown.set(!1),this.template.set(void 0),this.message.set(""),this.type.set("error"),this.title.set("Sorry, something went wrong"),this.dismissButtonText.set("dismiss")},this.isShown=()=>this.shown()}static{this.\u0275fac=function(e){return new(e||o)}}static{this.\u0275prov=g({token:o,factory:o.\u0275fac,providedIn:"root"})}}return o})();var j=o=>{try{return o()}catch(i){let t=i;if(t?.message?.startsWith("NG0950"))return;throw t}};var p="http://kapow:5984",H=`Basic ${btoa("admin:password")}`,y={Authorization:H,"Content-Type":"application/json"},u=U({headers:y}),pt=(()=>{class o{constructor(){this.baseUrl=`${p}/relations`,this.idUrl=t=>`${this.baseUrl}/${t}`,this.#t=m(k),this.#a=m(L),this.#s=m(B),this.#i=m(A),this.filter=c(""),this.#n=N(()=>`(?i)${this.filter()}`,{delay:250}),this.#o=c(0),this.sort=c("name"),this.order=c("asc"),this.#r=b(()=>({url:`${this.baseUrl}/_find?v=${this.#o()}`,method:"POST",body:{selector:{$or:[{name:{$regex:this.#n()}},{username:{$regex:this.#n()}},{email:{$regex:this.#n()}}]},fields:["id","_rev"],sort:[{[this.sort()]:this.order()}],limit:15},headers:y}),{defaultValue:[],parse:t=>(t?.docs??[]).map(e=>[e.id,e._rev])}),this.#e=this.#r.value,this.list=this.#e.asReadonly(),this.listIsLoading=this.#r.isLoading,this._DbError=T(async()=>{let t=this.#r.error();if(!t)return;let e=t.error?.reason;if(!e){console.error("Unknown error",t),this.#s.show({title:"CouchDB not found?",message:"This is a demo app, and it expects CouchDB to be running locally. Please check the console for more information."});return}if(e.startsWith("No index exists")){console.error("Index not found, creating it");try{await W().catch(s=>console.error("Error creating index",s)),this.#r.reload()}catch(s){console.error("Error creating index",s)}}if(e.startsWith("Database does not exist")){console.error("Database not found, creating it");try{await _(async()=>await this.#t.put(this.baseUrl,{},u)),await V(),this.#r.reload()}catch(s){console.error("Error creating database",s)}}console.error(t),this.#s.show({title:"CouchDB error?",message:"There is an unknown error with the database. Please check the console for more information."})}),this._subscription=J("relations",H).subscribe(t=>{if(this.#i.purge(this.idUrl(t.id)),t.deleted)this.#e.update(e=>e.filter(s=>s[0]!==t.id));else{let e=t.changes[0]?.rev??"";this.#e.update(s=>s.map(r=>r[0]===t.id?[r[0],e]:r))}}),this._=m(I).onDestroy(()=>{this._subscription.unsubscribe()}),this.create=async t=>{let e=this.idUrl(t.id);try{let s=await this.#t.put(e,t,u);return console.dir(s),this.#e.update(r=>[[t.id,""],...r].splice(0,50)),!0}catch(s){return console.error("Error creating user",s),!1}},this.read=(t,e=u)=>{let s=v(()=>j(t)??""),r=v(()=>{if(s())return C({url:this.idUrl(s())},e)});return b(r,{defaultValue:{id:s()}})},this.update=async t=>{let e=t.id,s=this.idUrl(e),r=await this.#t.get(s,u);if($(r,t))return{result:"noChange"};try{let{rev:n}=await this.#t.put(s,t,u);return r[this.sort()]!==t[this.sort()]?(console.log(`sort field changed from ${r[this.sort()]} to ${t[this.sort()]}`),this.#o.update(a=>a+1)):this.#e.update(a=>a.reduce((h,l)=>[...h,[l[0],l[0]===e?n:l[1]]],[])),{result:"ok",rev:n}}catch(n){let{error:{error:a,reason:h}}=n??{};if(console.log(n,a,h),h.startsWith("Document update conflict"))try{this.#i.purge(s);let l=w(r,t),f=await this.#t.get(s,u),z=w(r,f),G=P(f,l);return this.#s.show({title:"Sorry, we detected a conflict",message:"we have merged in the upstream change, please verify your edit, and submit your changes again"}),{result:"conflict",user:G}}catch{this.#s.show({title:"Sorry, but an unrecoverable error happened",message:"please reload your app"})}return{result:"error",error:n}}},this.delete=async t=>{let e=t.id,s=this.idUrl(e)+`?rev=${t._rev}`;try{await this.#t.delete(s,u)}catch(r){let{error:{error:n,reason:a}}=r??{};if(n==="not_found"&&a==="deleted")console.log("already deleted, ignore this log");else{this.#i.purge(s),this.#s.show({title:"The data was updated",message:"There was an update on the data you tried to delete. I have loaded the update into the view. Review, and try to delete again if still needed."});let{_rev:h}=await this.#t.get(s,u);return this.#e.update(l=>l.map(f=>f[0]===e?[f[0],h]:f)),!1}}return this.#e.update(r=>r.filter(n=>n[0]!==e)),!0},this.reFetch=async t=>{let e=this.idUrl(t);return D(this.#a.get(e,u))},this.info=async()=>{let t=`${this.baseUrl}`;return this.#t.get(t,u)}}#t;#a;#s;#i;#n;#o;#r;#e;static{this.\u0275fac=function(e){return new(e||o)}}static{this.\u0275prov=g({token:o,factory:o.\u0275fac})}}return o})();async function V(){let i=await import("./dist-QVLQ4CZR.js"),t=`${p}/relations/`;for(let e=0;e<=2500;e+=1){let s=await M(i.faker),r=await fetch(`${t}/${s.id}`,{method:"PUT",headers:y,body:JSON.stringify(s)})}}async function W(){await E("name"),await E("username"),await E("email"),console.log("Indexes created")}async function E(o){let i=`${p}/relations/_index`,t={index:{fields:[o]},name:o,type:"json",ddoc:"fieldIndex-"+o},e=await fetch(i,{method:"POST",headers:y,body:JSON.stringify(t)});if(!e.ok)throw new Error(`Error creating index: ${e.statusText}`);let s=await e.json();return console.log("Index created",s),s}function J(o,i){let t=`${p}/${o}`;return console.log("Starting CouchDB event listener for",t),new S(e=>{let s=new d(`${t}/_changes?feed=eventsource&include_docs=false&since=now`,{headers:{Authorization:i},withCredentials:!0,autoReconnect:!0,reconnectDelay:3e3,maxRetries:null,useLastEventId:!0});return s.onmessage=r=>{try{let n=JSON.parse(r.data);e.next(n)}catch(n){e.error(n)}},s.onerror=r=>{console.error("CouchDB EventSource error:",r),e.error(r),s.close()},s.stream(),()=>{s.close(),console.log("CouchDB event listener closed")}}).pipe(R(5))}export{B as a,F as b,w as c,pt as d};
