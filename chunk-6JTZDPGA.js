import{a as Ue,d as Ge,e as Ze}from"./chunk-ET3DIZKM.js";import{Da as Fe,Ga as _e,Hc as Ke,Ic as N,Jc as a,Kc as x,Lc as re,a as b,bd as $e,eb as je,ga as P,ka as te,nb as xe,pa as j,ra as Le,ta as Oe,ub as Ve,xa as R,zc as He}from"./chunk-UTYHTRAX.js";import{a as J,b as ee}from"./chunk-DAQOROHW.js";function p(r){return Array.isArray(r)}function m(r){return(typeof r=="object"||typeof r=="function")&&r!=null}function M(r,e,t,n){let i=r.structure.childrenMap();if(!i)return e;let s=e;for(let o of i.values()){if(n?.(s))break;s=t(o,s)}return s}function ut(r){return!r}function qe(r){return r}function lt(r){return r.errors().length>0?"invalid":r.pending()?"unknown":"valid"}var ie=class{node;constructor(e){this.node=e}rawSyncTreeErrors=a(()=>this.shouldSkipValidation()?[]:[...this.node.logicNode.logic.syncTreeErrors.compute(this.node.context),...this.node.structure.parent?.validationState.rawSyncTreeErrors()??[]]);syncErrors=a(()=>this.shouldSkipValidation()?[]:[...this.node.logicNode.logic.syncErrors.compute(this.node.context),...this.syncTreeErrors(),...ht(this.node.submitState.serverErrors())]);syncValid=a(()=>this.shouldSkipValidation()?!0:M(this.node,this.syncErrors().length===0,(e,t)=>t&&e.validationState.syncValid(),ut));syncTreeErrors=a(()=>this.rawSyncTreeErrors().filter(e=>e.field===this.node.fieldProxy));rawAsyncErrors=a(()=>this.shouldSkipValidation()?[]:[...this.node.logicNode.logic.asyncErrors.compute(this.node.context),...this.node.structure.parent?.validationState.rawAsyncErrors()??[]]);asyncErrors=a(()=>this.shouldSkipValidation()?[]:this.rawAsyncErrors().filter(e=>e==="pending"||e.field===this.node.fieldProxy));errors=a(()=>[...this.syncErrors(),...this.asyncErrors().filter(e=>e!=="pending")]);errorSummary=a(()=>M(this.node,this.errors(),(e,t)=>[...t,...e.errorSummary()]));pending=a(()=>M(this.node,this.asyncErrors().includes("pending"),(e,t)=>t||e.validationState.asyncErrors().includes("pending")));status=a(()=>{if(this.shouldSkipValidation())return"valid";let e=lt(this);return M(this.node,e,(t,n)=>n==="invalid"||t.validationState.status()==="invalid"?"invalid":n==="unknown"||t.validationState.status()==="unknown"?"unknown":"valid",t=>t==="invalid")});valid=a(()=>this.status()==="valid");invalid=a(()=>this.status()==="invalid");shouldSkipValidation=a(()=>this.node.hidden()||this.node.disabled()||this.node.readonly())};function ht(r){return r===void 0?[]:p(r)?r:[r]}function De(r,e){if(p(r))for(let t of r)t.field??=e;else r&&(r.field??=e);return r}var se=Symbol(),B=Symbol(),L=class{predicates;fns=[];constructor(e){this.predicates=e}push(e){this.fns.push(Be(this.predicates,e))}mergeIn(e){let t=this.predicates?e.fns.map(n=>Be(this.predicates,n)):e.fns;this.fns.push(...t)}},H=class extends L{get defaultValue(){return!1}compute(e){return this.fns.some(t=>{let n=t(e);return n&&n!==B})}},D=class r extends L{ignore;static ignoreNull(e){return new r(e,t=>t===null)}constructor(e,t){super(e),this.ignore=t}get defaultValue(){return[]}compute(e){return this.fns.reduce((t,n)=>{let i=n(e);return i===void 0||i===B?t:p(i)?[...t,...this.ignore?i.filter(s=>!this.ignore(s)):i]:this.ignore&&this.ignore(i)?t:[...t,i]},[])}},oe=class extends D{constructor(e){super(e,void 0)}},ae=class extends L{key;get defaultValue(){return this.key.getInitial()}constructor(e,t){super(e),this.key=t}compute(e){if(this.fns.length===0)return this.key.getInitial();let t=this.key.getInitial();for(let n=0;n<this.fns.length;n++){let i=this.fns[n](e);i!==B&&(t=this.key.reduce(t,i))}return t}};function Be(r,e){return r.length===0?e:t=>{for(let n of r){let i=t.stateOf(n.path),s=N(i.structure.pathKeys).length-n.depth;for(let o=0;o<s;o++)i=i.structure.parent;if(!n.fn(i.context))return B}return e(t)}}var I=class{predicates;hidden;disabledReasons;readonly;syncErrors;syncTreeErrors;asyncErrors;aggregateProperties=new Map;propertyFactories=new Map;constructor(e){this.predicates=e,this.hidden=new H(e),this.disabledReasons=new oe(e),this.readonly=new H(e),this.syncErrors=D.ignoreNull(e),this.syncTreeErrors=D.ignoreNull(e),this.asyncErrors=D.ignoreNull(e)}hasAggregateProperty(e){return this.aggregateProperties.has(e)}getAggregatePropertyEntries(){return this.aggregateProperties.entries()}getPropertyFactoryEntries(){return this.propertyFactories.entries()}getAggregateProperty(e){return this.aggregateProperties.has(e)||this.aggregateProperties.set(e,new ae(this.predicates,e)),this.aggregateProperties.get(e)}addPropertyFactory(e,t){if(this.propertyFactories.has(e))throw new Error("Can't define value twice for the same Property");this.propertyFactories.set(e,t)}mergeIn(e){this.hidden.mergeIn(e.hidden),this.disabledReasons.mergeIn(e.disabledReasons),this.readonly.mergeIn(e.readonly),this.syncErrors.mergeIn(e.syncErrors),this.syncTreeErrors.mergeIn(e.syncTreeErrors),this.asyncErrors.mergeIn(e.asyncErrors);for(let[t,n]of e.getAggregatePropertyEntries())this.getAggregateProperty(t).mergeIn(n);for(let[t,n]of e.getPropertyFactoryEntries())this.addPropertyFactory(t,n)}},de=0;function ct(){return de}function v(r,e){return(...t)=>{try{return de=e,r(...t)}finally{de=0}}}var K=class{depth;constructor(e){this.depth=e}build(){return new $(this,[],0)}},T=class r extends K{constructor(e){super(e)}current;all=[];addHiddenRule(e){this.getCurrent().addHiddenRule(e)}addDisabledReasonRule(e){this.getCurrent().addDisabledReasonRule(e)}addReadonlyRule(e){this.getCurrent().addReadonlyRule(e)}addSyncErrorRule(e){this.getCurrent().addSyncErrorRule(e)}addSyncTreeErrorRule(e){this.getCurrent().addSyncTreeErrorRule(e)}addAsyncErrorRule(e){this.getCurrent().addAsyncErrorRule(e)}addAggregatePropertyRule(e,t){this.getCurrent().addAggregatePropertyRule(e,t)}addPropertyFactory(e,t){this.getCurrent().addPropertyFactory(e,t)}getChild(e){return this.getCurrent().getChild(e)}hasLogic(e){return this===e?!0:this.all.some(({builder:t})=>t.hasLogic(e))}mergeIn(e,t){t?this.all.push({builder:e,predicate:{fn:v(t.fn,this.depth),path:t.path}}):this.all.push({builder:e}),this.current=void 0}getCurrent(){return this.current===void 0&&(this.current=new O(this.depth),this.all.push({builder:this.current})),this.current}static newRoot(){return new r(0)}},O=class extends K{logic=new I([]);children=new Map;constructor(e){super(e)}addHiddenRule(e){this.logic.hidden.push(v(e,this.depth))}addDisabledReasonRule(e){this.logic.disabledReasons.push(v(e,this.depth))}addReadonlyRule(e){this.logic.readonly.push(v(e,this.depth))}addSyncErrorRule(e){this.logic.syncErrors.push(v(e,this.depth))}addSyncTreeErrorRule(e){this.logic.syncTreeErrors.push(v(e,this.depth))}addAsyncErrorRule(e){this.logic.asyncErrors.push(v(e,this.depth))}addAggregatePropertyRule(e,t){this.logic.getAggregateProperty(e).push(v(t,this.depth))}addPropertyFactory(e,t){this.logic.addPropertyFactory(e,v(t,this.depth))}getChild(e){return this.children.has(e)||this.children.set(e,new T(this.depth+1)),this.children.get(e)}hasLogic(e){return this===e}},$=class r{builder;predicates;depth;logic;constructor(e,t,n){this.builder=e,this.predicates=t,this.depth=n,this.logic=e?ft(e,t,n):new I([])}getChild(e){let t=this.builder?Qe(this.builder,e):[];if(t.length===0)return new r(void 0,[],this.depth+1);if(t.length===1){let{builder:n,predicates:i}=t[0];return new r(n,[...this.predicates,...i.map(s=>le(s,this.depth))],this.depth+1)}else{let n=t.map(({builder:i,predicates:s})=>new r(i,[...this.predicates,...s.map(o=>le(o,this.depth))],this.depth+1));return new ue(n)}}hasLogic(e){return this.builder?.hasLogic(e)??!1}},ue=class r{all;logic;constructor(e){this.all=e,this.logic=new I([]);for(let t of e)this.logic.mergeIn(t.logic)}getChild(e){return new r(this.all.flatMap(t=>t.getChild(e)))}hasLogic(e){return this.all.some(t=>t.hasLogic(e))}};function Qe(r,e){if(r instanceof T)return r.all.flatMap(({builder:t,predicate:n})=>{let i=Qe(t,e);return n?i.map(({builder:s,predicates:o})=>({builder:s,predicates:[...o,n]})):i});if(r instanceof O){if(r.children.has(e))return[{builder:r.children.get(e),predicates:[]}]}else throw new Error("Unknown LogicNodeBuilder type");return[]}function ft(r,e,t){let n=new I(e);if(r instanceof T){let i=r.all.map(({builder:s,predicate:o})=>new $(s,o?[...e,le(o,t)]:e,t));for(let s of i)n.mergeIn(s.logic)}else if(r instanceof O)n.mergeIn(r.logic);else throw new Error("Unknown LogicNodeBuilder type");return n}function le(r,e){return ee(J({},r),{depth:e})}var Je=Symbol("PATH"),f=class r{keys;logic;root;children=new Map;fieldPathProxy=new Proxy(this,gt);constructor(e,t,n){this.keys=e,this.logic=t,this.root=n??this}get element(){return this.getChild(se)}getChild(e){return this.children.has(e)||this.children.set(e,new r([...this.keys,e],this.logic.getChild(e),this.root)),this.children.get(e)}mergeIn(e,t){let n=e.compile();this.logic.mergeIn(n.logic,t)}static unwrapFieldPath(e){return e[Je]}static newRoot(){return new r([],T.newRoot(),void 0)}},gt={get(r,e){return e===Je?r:r.getChild(e).fieldPathProxy}},V,z=new Map,k=class r{schemaFn;constructor(e){this.schemaFn=e}compile(){if(z.has(this))return z.get(this);let e=f.newRoot();z.set(this,e);let t=V;try{V=e,this.schemaFn(e.fieldPathProxy)}finally{V=t}return e}static create(e){return e instanceof r?e:new r(e)}static rootCompile(e){try{return z.clear(),e===void 0?f.newRoot():e instanceof r?e.compile():new r(e).compile()}finally{z.clear()}}};function yt(r){return r instanceof k||typeof r=="function"}function S(r){if(V!==f.unwrapFieldPath(r).root)throw new Error("A FieldPath can only be used directly within the Schema that owns it, **not** outside of it or within a sub-schema.")}var U=class{brand;constructor(){}};function mt(){return new U}var G=class{reduce;getInitial;brand;constructor(e,t){this.reduce=e,this.getInitial=t}};function X(r,e){return new G(r,e)}function pt(){return X((r,e)=>e===void 0?r:[...r,e],()=>[])}function et(){return X((r,e)=>r===void 0?e:e===void 0?r:Math.min(r,e),()=>{})}function tt(){return X((r,e)=>r===void 0?e:e===void 0?r:Math.max(r,e),()=>{})}function bt(){return X((r,e)=>r||e,()=>!1)}var Z=bt(),Xe=tt(),Ye=et(),he=tt(),ce=et(),vt=pt();function qt(r,e){S(r),f.unwrapFieldPath(r).logic.addDisabledReasonRule(n=>{let i=!0;return typeof e=="string"?i=e:e&&(i=e(n)),typeof i=="string"?{field:n.field,message:i}:i?{field:n.field}:void 0})}function Bt(r,e=()=>!0){S(r),f.unwrapFieldPath(r).logic.addReadonlyRule(e)}function Ie(r,e){S(r),f.unwrapFieldPath(r).logic.addSyncErrorRule(n=>De(e(n),n.field))}function Te(r,e,t){S(r),f.unwrapFieldPath(r).logic.addAggregatePropertyRule(e,t)}function Y(r,...e){S(r);let t,n;return e.length===2?[t,n]=e:[n]=e,t??=mt(),f.unwrapFieldPath(r).logic.addPropertyFactory(t,n),t}function Xt(r,e){S(r);let t=f.unwrapFieldPath(r),n=Y(r,i=>{let s=a(()=>{let d=i.stateOf(r).validationState;if(!(d.shouldSkipValidation()||!d.syncValid()))return e.params(i)});return e.factory(s)});t.logic.addAsyncErrorRule(i=>{let s=i.state.property(n);switch(s.status()){case"idle":return;case"loading":case"reloading":return"pending";case"resolved":case"local":if(!s.hasValue())return;let o=e.errors(s.value(),i);return De(o,i.field);case"error":throw s.error()}})}var fe=class{field;constructor(e){this.field=e}control=this;get value(){return this.field().value()}get valid(){return this.field().valid()}get invalid(){return this.field().invalid()}get pending(){return this.field().pending()}get disabled(){return this.field().disabled()}get enabled(){return!this.field().disabled()}get errors(){let e=this.field().errors();if(e.length===0)return null;let t={};for(let n of e)t[n.kind]=n;return t}get pristine(){return!this.field().dirty()}get dirty(){return this.field().dirty()}get touched(){return this.field().touched()}get untouched(){return!this.field().touched()}get status(){if(this.field().disabled())return"DISABLED";if(this.field().valid())return"VALID";if(this.field().invalid())return"INVALID";if(this.field().pending())return"PENDING";throw Error("AssertionError: unknown form control status")}valueAccessor=null;hasValidator(e){return e===Ge.required?this.field().property(Z)():!1}updateValueAndValidity(){}};function St(r){if(Nt(r),!(r._tNode.directiveStart===0||r._tNode.componentOffset===-1))return r._lView[r._tNode.directiveStart+r._tNode.componentOffset]}function wt(r,e){r[b].applyValueToInputSignal(r[b],e)}function g(r){return rt(r)}function F(r){return rt(r)&&m(r)&&"subscribe"in r}function Et(r){r[b].run()}function Nt(r){if(!("_tNode"in r))throw new Error("Expected a Node Injector")}function rt(r){if(!m(r)||!(b in r))return!1;let e=r[b];return m(e)&&"applyValueToInputSignal"in e}var Yt=(()=>{class r{injector=P(j);renderer=P(je);initialized=!1;field=R(void 0);set _field(t){this.field.set(t),this.initialized||this.initialize()}state=a(()=>this.field()());el=P(Fe);cvaArray=P(Ue,{optional:!0});_ngControl;get ngControl(){return this._ngControl??=new fe(()=>this.state())}get cva(){return this.cvaArray?.[0]??this._ngControl?.valueAccessor??void 0}initialize(){this.initialized=!0;let t=this.injector,n=St(t);if(!(n&&Pt(n))){if(n&&At(n))this.setupCustomUiControl(n);else if(this.cva!==void 0)this.setupControlValueAccessor(this.cva);else if(this.el.nativeElement instanceof HTMLInputElement||this.el.nativeElement instanceof HTMLTextAreaElement||this.el.nativeElement instanceof HTMLSelectElement)this.setupNativeInput(this.el.nativeElement);else throw new Error("Unhandled control?");x(i=>{let s=this.state();s.nodeState.controls.update(o=>[...o,this]),i(()=>{s.nodeState.controls.update(o=>o.filter(d=>d!==this))})},{injector:this.injector})}}setupNativeInput(t){let n=t instanceof HTMLTextAreaElement?"text":t instanceof HTMLSelectElement?"select":t.type;switch(t.addEventListener("input",()=>{switch(n){case"checkbox":this.state().value.set(t.checked);break;case"radio":this.state().value.set(t.value);break;case"number":case"range":case"datetime-local":typeof this.state().value()=="number"?this.state().value.set(t.valueAsNumber):this.state().value.set(t.value);break;case"date":case"month":case"week":case"time":We(this.state().value())?this.state().value.set(t.valueAsDate):typeof this.state().value()=="number"?this.state().value.set(t.valueAsNumber):this.state().value.set(t.value);break;default:this.state().value.set(t.value);break}this.state().markAsDirty()}),t.addEventListener("blur",()=>this.state().markAsTouched()),this.maybeSynchronize(()=>this.state().readonly(),this.withBooleanAttribute(t,"readonly")),this.maybeSynchronize(()=>this.state().disabled(),this.withBooleanAttribute(t,"disabled")),this.maybeSynchronize(()=>this.state().name(),this.withAttribute(t,"name")),this.maybeSynchronize(this.propertySource(Z),this.withBooleanAttribute(t,"required")),this.maybeSynchronize(this.propertySource(Xe),this.withAttribute(t,"min")),this.maybeSynchronize(this.propertySource(he),this.withAttribute(t,"minLength")),this.maybeSynchronize(this.propertySource(Ye),this.withAttribute(t,"max")),this.maybeSynchronize(this.propertySource(ce),this.withAttribute(t,"maxLength")),n){case"checkbox":this.maybeSynchronize(()=>this.state().value(),i=>t.checked=i);break;case"radio":this.maybeSynchronize(()=>this.state().value(),i=>{t.checked=t.value===i});break;case"select":this.maybeSynchronize(()=>this.state().value(),i=>{Ve(()=>t.value=i,{injector:this.injector})});break;case"number":case"range":case"datetime-local":this.maybeSynchronize(()=>this.state().value(),i=>{typeof i=="number"?t.valueAsNumber=i:t.value=i});break;case"date":case"month":case"week":case"time":this.maybeSynchronize(()=>this.state().value(),i=>{We(i)?t.valueAsDate=i:typeof i=="number"?t.valueAsNumber=i:t.value=i});break;default:this.maybeSynchronize(()=>this.state().value(),i=>{t.value=i});break}}setupControlValueAccessor(t){t.registerOnChange(n=>this.state().value.set(n)),t.registerOnTouched(()=>this.state().markAsTouched()),this.maybeSynchronize(()=>this.state().value(),n=>t.writeValue(n)),t.setDisabledState&&this.maybeSynchronize(()=>this.state().disabled(),n=>t.setDisabledState(n)),t.writeValue(this.state().value()),t.setDisabledState?.(this.state().disabled())}setupCustomUiControl(t){let n;if(nt(t))this.maybeSynchronize(()=>this.state().value(),h(t.value)),n=t.value.subscribe(o=>this.state().value.set(o));else if(it(t))this.maybeSynchronize(()=>this.state().value(),h(t.checked)),n=t.checked.subscribe(o=>this.state().value.set(o));else throw new Error("Unknown custom control subtype");this.maybeSynchronize(()=>this.state().name(),h(t.name)),this.maybeSynchronize(()=>this.state().disabled(),h(t.disabled)),this.maybeSynchronize(()=>this.state().disabledReasons(),h(t.disabledReasons)),this.maybeSynchronize(()=>this.state().readonly(),h(t.readonly)),this.maybeSynchronize(()=>this.state().hidden(),h(t.hidden)),this.maybeSynchronize(()=>this.state().errors(),h(t.errors)),(F(t.touched)||g(t.touched))&&this.maybeSynchronize(()=>this.state().touched(),h(t.touched)),this.maybeSynchronize(()=>this.state().dirty(),h(t.dirty)),this.maybeSynchronize(()=>this.state().invalid(),h(t.invalid)),this.maybeSynchronize(()=>this.state().pending(),h(t.pending)),this.maybeSynchronize(this.propertySource(Z),h(t.required)),this.maybeSynchronize(this.propertySource(Xe),h(t.min)),this.maybeSynchronize(this.propertySource(he),h(t.minLength)),this.maybeSynchronize(this.propertySource(Ye),h(t.max)),this.maybeSynchronize(this.propertySource(ce),h(t.maxLength)),this.maybeSynchronize(this.propertySource(vt),h(t.pattern));let i,s;if(F(t.touched)||st(t.touched))i=t.touched.subscribe(()=>this.state().markAsTouched());else{let o=d=>{let w=d.relatedTarget;this.el.nativeElement.contains(w)||this.state().markAsTouched()};this.el.nativeElement.addEventListener("focusout",o),s=()=>this.el.nativeElement.removeEventListener("focusout",o)}this.injector.get(Le).onDestroy(()=>{n?.unsubscribe(),i?.unsubscribe(),s?.()})}maybeSynchronize(t,n){if(!n)return;let i=x(()=>{let s=t();N(()=>n(s))},{injector:this.injector});Et(i)}propertySource(t){let n=a(()=>this.state().hasProperty(t)?this.state().property(t):t.getInitial);return()=>n()?.()}withAttribute(t,n){return i=>{i!==void 0?this.renderer.setAttribute(t,n,i.toString()):this.renderer.removeAttribute(t,n)}}withBooleanAttribute(t,n){return i=>{i?this.renderer.setAttribute(t,n,""):this.renderer.removeAttribute(t,n)}}static \u0275fac=function(n){return new(n||r)};static \u0275dir=xe({type:r,selectors:[["","control",""]],inputs:{_field:[0,"control","_field"]},features:[He([{provide:Ze,useFactory:()=>P(r).ngControl}])]})}return r})();function h(r){return r?e=>wt(r,e):void 0}function At(r){let e=r;return(nt(e)||it(e))&&(e.readonly===void 0||g(e.readonly))&&(e.disabled===void 0||g(e.disabled))&&(e.disabledReasons===void 0||g(e.disabledReasons))&&(e.errors===void 0||g(e.errors))&&(e.invalid===void 0||g(e.invalid))&&(e.pending===void 0||g(e.pending))&&(e.touched===void 0||F(e.touched)||g(e.touched)||st(e.touched))&&(e.dirty===void 0||g(e.dirty))&&(e.min===void 0||g(e.min))&&(e.minLength===void 0||g(e.minLength))&&(e.max===void 0||g(e.max))&&(e.maxLength===void 0||g(e.maxLength))}function nt(r){return F(r.value)}function it(r){return F(r.checked)&&r.value===void 0}function Pt(r){return $e(r.constructor)?.inputs.some(t=>t.templateName==="control")??!1}function st(r){return r instanceof Ke||r instanceof Oe}function We(r){return r===null||r instanceof Date}var ge=class{node;cache=new WeakMap;constructor(e){this.node=e}resolve(e){if(!this.cache.has(e)){let t=a(()=>{let n=f.unwrapFieldPath(e),i=this.node,s=ct();for(;s>0||!i.structure.logic.hasLogic(n.root.logic);)if(s--,i=i.structure.parent,i===void 0)throw new Error("Path is not part of this field tree.");for(let o of n.keys)if(i=i.structure.getChild(o),i===void 0)throw new Error(`Cannot resolve path .${n.keys.join(".")} relative to field ${["<root>",...this.node.structure.pathKeys()].join(".")}.`);return i.fieldProxy});this.cache.set(e,t)}return this.cache.get(e)()}get field(){return this.node.fieldProxy}get state(){return this.node}get value(){return this.node.structure.value}get key(){return this.node.structure.keyInParent}index=a(()=>{let e=this.key();if(!p(N(this.node.structure.parent.value)))throw new Error("RuntimeError: cannot access index, parent field is not an array");return Number(e)});fieldOf=e=>this.resolve(e);stateOf=e=>this.resolve(e)();valueOf=e=>this.resolve(e)().value()},ye=class{node;properties=new Map;constructor(e){this.node=e,N(()=>te(this.node.structure.injector,()=>{for(let[t,n]of this.node.logicNode.logic.getPropertyFactoryEntries())this.properties.set(t,n(this.node.context))}))}get(e){if(e instanceof U)return this.properties.get(e);if(!this.properties.has(e)){let t=this.node.logicNode.logic.getAggregateProperty(e),n=a(()=>t.compute(this.node.context));this.properties.set(e,n)}return this.properties.get(e)}has(e){return e instanceof G?this.node.logicNode.logic.hasAggregateProperty(e):this.properties.has(e)}},kt={get(r,e){let t=r(),n=t.structure.getChild(e);if(n!==void 0)return n.fieldProxy;let i=N(t.value);if(p(i)){if(e==="length")return t.value().length;if(e===Symbol.iterator)return Array.prototype[e]}}};function Rt(r,e){let t=a(()=>r()[e()]);return t[b]=r[b],t.set=n=>{r.update(i=>Mt(i,n,e()))},t.update=n=>{t.set(n(N(t)))},t.asReadonly=()=>t,t}function Mt(r,e,t){if(p(r)){let n=[...r];return n[t]=e,n}else return ee(J({},r),{[t]:e})}var q=class{logic;identitySymbol=Symbol();_injector=void 0;get injector(){return this._injector??=j.create({providers:[],parent:this.fieldManager.injector}),this._injector}constructor(e){this.logic=e}children(){return this.childrenMap()?.values()??[]}getChild(e){let t=this.childrenMap(),n=this.value();if(!(!t||!m(n))){if(p(n)){let i=n[e];m(i)&&i.hasOwnProperty(this.identitySymbol)&&(e=i[this.identitySymbol])}return t.get(typeof e=="number"?e.toString():e)}}destroy(){this.injector.destroy()}},me=class extends q{node;fieldManager;value;get parent(){}get root(){return this.node}get pathKeys(){return Dt}get keyInParent(){return It}childrenMap;constructor(e,t,n,i,s,o,d){super(n),this.node=e,this.fieldManager=i,this.value=s,this.childrenMap=ot(e,s,this.identitySymbol,t,n,o,d)}},pe=class extends q{parent;root;pathKeys;keyInParent;value;childrenMap;get fieldManager(){return this.root.structure.fieldManager}constructor(e,t,n,i,s,o,d,w){if(super(n),this.parent=i,this.root=this.parent.structure.root,this.pathKeys=a(()=>[...i.structure.pathKeys(),this.keyInParent()]),s===void 0){let u=o;this.keyInParent=a(()=>{if(i.structure.childrenMap()?.get(u)!==e)throw new Error(`RuntimeError: orphan field, looking for property '${u}' of ${ne(i)}`);return u})}else{let u=o;this.keyInParent=a(()=>{let E=i.structure.value();if(!p(E))throw new Error(`RuntimeError: orphan field, expected ${ne(i)} to be an array`);let c=E[u];if(m(c)&&c.hasOwnProperty(i.structure.identitySymbol)&&c[i.structure.identitySymbol]===s)return u;for(let l=0;l<E.length;l++){let y=E[l];if(m(y)&&y.hasOwnProperty(i.structure.identitySymbol)&&y[i.structure.identitySymbol]===s)return u=l.toString()}throw new Error(`RuntimeError: orphan field, can't find element in array ${ne(i)}`)})}this.value=Rt(this.parent.structure.value,this.keyInParent),this.childrenMap=ot(e,this.value,this.identitySymbol,t,n,d,w),this.fieldManager.structures.add(this)}};var Dt=a(()=>[]),It=a(()=>{throw new Error("RuntimeError: the top-level field in the form has no parent")});function ot(r,e,t,n,i,s,o){return re({source:e,computation:(d,w)=>{let u=w?.value;if(!m(d))return;let E=p(d);if(u!==void 0){let c;if(E){c=new Set(u.keys());for(let l=0;l<d.length;l++){let y=d[l];m(y)&&y.hasOwnProperty(t)?c.delete(y[t]):c.delete(l.toString())}for(let l of c)u.delete(l)}else for(let l of u.keys())d.hasOwnProperty(l)||u.delete(l)}for(let c of Object.keys(d)){let l,y=d[c];if(y===void 0){u?.delete(c);continue}E&&m(y)&&(l=y[t]??=Symbol(""));let ze=l??c;if(u?.has(ze))continue;let W,Q;E?(W=n.getChild(se),Q=i.getChild(se)):(W=n.getChild(c),Q=i.getChild(c)),u??=new Map,u.set(ze,o({kind:"child",parent:r,pathNode:W,logic:Q,initialKeyInParent:c,identityInParent:l,fieldAdapter:s}))}return u},equal:()=>!1})}function ne(r){return`<root>.${r.structure.pathKeys().join(".")}`}var be=class{node;selfSubmitting=R(!1);serverErrors;constructor(e){this.node=e,this.serverErrors=re({source:this.node.structure.value,computation:()=>[]})}submitting=a(()=>this.selfSubmitting()||(this.node.structure.parent?.submitting()??!1))},_=class r{structure;validationState;propertyState;nodeState;submitState;_context=void 0;fieldAdapter;get context(){return this._context??=new ge(this)}fieldProxy=new Proxy(()=>this,kt);constructor(e){this.fieldAdapter=e.fieldAdapter,this.structure=this.fieldAdapter.createStructure(this,e),this.validationState=this.fieldAdapter.createValidationState(this,e),this.nodeState=this.fieldAdapter.createNodeState(this,e),this.propertyState=new ye(this),this.submitState=new be(this)}get logicNode(){return this.structure.logic}get value(){return this.structure.value}get keyInParent(){return this.structure.keyInParent}get errors(){return this.validationState.errors}get errorSummary(){return this.validationState.errorSummary}get pending(){return this.validationState.pending}get valid(){return this.validationState.valid}get invalid(){return this.validationState.invalid}get dirty(){return this.nodeState.dirty}get touched(){return this.nodeState.touched}get disabled(){return this.nodeState.disabled}get disabledReasons(){return this.nodeState.disabledReasons}get hidden(){return this.nodeState.hidden}get readonly(){return this.nodeState.readonly}get controls(){return this.nodeState.controls}get submitting(){return this.submitState.submitting}get name(){return this.nodeState.name}property(e){return this.propertyState.get(e)}hasProperty(e){return this.propertyState.has(e)}markAsTouched(){this.nodeState.markAsTouched()}markAsDirty(){this.nodeState.markAsDirty()}reset(){this.nodeState.markAsUntouched(),this.nodeState.markAsPristine();for(let e of this.structure.children())e.reset()}static newRoot(e,t,n,i){return i.newRoot(e,t,n,i)}static newChild(e){return e.fieldAdapter.newChild(e)}createStructure(e){return e.kind==="root"?new me(this,e.pathNode,e.logic,e.fieldManager,e.value,e.fieldAdapter,r.newChild):new pe(this,e.pathNode,e.logic,e.parent,e.identityInParent,e.initialKeyInParent,e.fieldAdapter,r.newChild)}},ve=class{node;selfTouched=R(!1);selfDirty=R(!1);markAsTouched(){this.selfTouched.set(!0)}markAsDirty(){this.selfDirty.set(!0)}markAsPristine(){this.selfDirty.set(!1)}markAsUntouched(){this.selfTouched.set(!1)}controls=R([]);constructor(e){this.node=e}dirty=a(()=>{let e=this.selfDirty()&&!this.isNonInteractive();return M(this.node,e,(t,n)=>n||t.nodeState.dirty(),qe)});touched=a(()=>{let e=this.selfTouched()&&!this.isNonInteractive();return M(this.node,e,(t,n)=>n||t.nodeState.touched(),qe)});disabledReasons=a(()=>[...this.node.structure.parent?.nodeState.disabledReasons()??[],...this.node.logicNode.logic.disabledReasons.compute(this.node.context)]);disabled=a(()=>!!this.disabledReasons().length);readonly=a(()=>(this.node.structure.parent?.nodeState.readonly()||this.node.logicNode.logic.readonly.compute(this.node.context))??!1);hidden=a(()=>(this.node.structure.parent?.nodeState.hidden()||this.node.logicNode.logic.hidden.compute(this.node.context))??!1);name=a(()=>{let e=this.node.structure.parent;return e?`${e.name()}.${this.node.structure.keyInParent()}`:this.node.structure.fieldManager.rootName});isNonInteractive=a(()=>this.hidden()||this.disabled()||this.readonly())},Se=class{newRoot(e,t,n,i){return new _({kind:"root",fieldManager:e,value:t,pathNode:n,logic:n.logic.build(),fieldAdapter:i})}newChild(e){return new _(e)}createNodeState(e){return new ve(e)}createValidationState(e){return new ie(e)}createStructure(e,t){return e.createStructure(t)}},we=class{injector;rootName;constructor(e,t){this.injector=e,this.rootName=t??`${this.injector.get(_e)}.form${Tt++}`}structures=new Set;createFieldManagementEffect(e){x(()=>{let t=new Set;this.markStructuresLive(e,t);for(let n of this.structures)t.has(n)||(this.structures.delete(n),N(()=>n.destroy()))},{injector:this.injector})}markStructuresLive(e,t){t.add(e);for(let n of e.children())this.markStructuresLive(n.structure,t)}},Tt=0;function Ct(r){let e,t,n;return r.length===3?[e,t,n]=r:r.length===2?yt(r[1])?[e,t]=r:[e,n]=r:[e]=r,[e,t,n]}function Wt(...r){let[e,t,n]=Ct(r),i=n?.injector??P(j),s=te(i,()=>k.rootCompile(t)),o=new we(i,n?.name),d=n?.adapter??new Se,w=_.newRoot(o,e,s,d);return o.createFieldManagementEffect(w.structure),w.fieldProxy}function Qt(r,e){S(r);let t=f.unwrapFieldPath(r).element.fieldPathProxy;zt(t,e)}function zt(r,e){S(r),f.unwrapFieldPath(r).mergeIn(k.create(e))}function Lt(r,e,t){S(r),f.unwrapFieldPath(r).mergeIn(k.create(t),{fn:e,path:r})}function Jt(r,e,t){Lt(r,({value:n})=>e(n()),t)}async function er(r,e){let t=r();if(at(t),!t.invalid()){t.submitState.selfSubmitting.set(!0);try{let n=await e(r);n&&Ot(t,n)}finally{t.submitState.selfSubmitting.set(!1)}}}function Ot(r,e){p(e)||(e=[e]);let t=new Map;for(let n of e){let i=De(n,r.fieldProxy),s=i.field(),o=t.get(s);o||(o=[],t.set(s,o)),o.push(i)}for(let[n,i]of t)n.submitState.serverErrors.set(i)}function tr(r){return k.create(r)}function at(r){r.markAsTouched();for(let e of r.structure.children())at(e)}function Ft(r){return new Ne(r)}function rr(r,e){return new Ae(r,e)}function nr(r,e){return new Pe(r,e)}function _t(r,e){return new ke(r,e)}function jt(r,e){return new Re(r,e)}function ir(r,e){return new Me(r,e)}function sr(r){return new Ee(r)}var Ee=class{__brand=void 0;kind="";field;message;constructor(e){e&&Object.assign(this,e)}},A=class{__brand=void 0;kind="";field;message;constructor(e){e&&Object.assign(this,e)}},Ne=class extends A{kind="required"},Ae=class extends A{min;kind="min";constructor(e,t){super(t),this.min=e}},Pe=class extends A{max;kind="max";constructor(e,t){super(t),this.max=e}},ke=class extends A{minLength;kind="minLength";constructor(e,t){super(t),this.minLength=e}},Re=class extends A{maxLength;kind="maxLength";constructor(e,t){super(t),this.maxLength=e}},Me=class extends A{pattern;kind="pattern";constructor(e,t){super(t),this.pattern=e}};function dt(r){let e=r;return typeof e.length=="number"?e.length:e.size}function C(r,e){return r instanceof Function?r(e):r}function Ce(r){return typeof r=="number"?isNaN(r):r===""||r===!1||r==null}function or(r,e,t){let n=Y(r,i=>a(()=>typeof e=="number"?e:e(i)));Te(r,ce,({state:i})=>i.property(n)()),Ie(r,i=>{if(Ce(i.value()))return;let s=i.state.property(n)();if(s!==void 0&&dt(i.value())>s)return t?.error?C(t.error,i):jt(s,{message:C(t?.message,i)})})}function ar(r,e,t){let n=Y(r,i=>a(()=>typeof e=="number"?e:e(i)));Te(r,he,({state:i})=>i.property(n)()),Ie(r,i=>{if(Ce(i.value()))return;let s=i.state.property(n)();if(s!==void 0&&dt(i.value())<s)return t?.error?C(t.error,i):_t(s,{message:C(t?.message,i)})})}function dr(r,e){let t=Y(r,n=>a(()=>e?.when?e.when(n):!0));Te(r,Z,({state:n})=>n.property(t)()),Ie(r,n=>{if(n.state.property(t)()&&Ce(n.value()))return e?.error?C(e.error,n):Ft({message:C(e?.message,n)})})}export{qt as a,Bt as b,Ie as c,Xt as d,Yt as e,Wt as f,Qt as g,zt as h,Jt as i,er as j,tr as k,rr as l,nr as m,_t as n,ir as o,sr as p,Re as q,or as r,ar as s,dr as t};
