import{a as U,b as B}from"./chunk-S7OBJA5N.js";import{b as A}from"./chunk-JMBT54ST.js";import{f as b,g as $,h as O,i as P,l as M}from"./chunk-W2VLP4QA.js";import{d as k,h as w}from"./chunk-MQQL2PHB.js";import{Aa as N,Rc as x,S as T,aa as v,d as R,fa as m,p as I,qa as _,wa as c,za as L}from"./chunk-CVECPIPU.js";import{a as y,b as S}from"./chunk-C6Q5SG76.js";var d=function(o,n){if(!(this instanceof d))return new d(o,n);this.url=o,n=n||{},this.headers=n.headers||{},this.payload=n.payload!==void 0?n.payload:"",this.method=n.method||this.payload&&"POST"||"GET",this.withCredentials=!!n.withCredentials,this.debug=!!n.debug,this.autoReconnect=n.autoReconnect!==void 0?n.autoReconnect:!1,this.reconnectDelay=n.reconnectDelay!==void 0?n.reconnectDelay:3e3,this.maxRetries=n.maxRetries!==void 0?n.maxRetries:null,this.retryCount=0,this.reconnectTimer=null,this.useLastEventId=n.useLastEventId!==void 0?n.useLastEventId:!0,this.FIELD_SEPARATOR=":",this.listeners={},this.xhr=null,this.readyState=d.INITIALIZING,this.progress=0,this.chunk="",this.lastEventId="",this.addEventListener=function(e,t){this.listeners[e]===void 0&&(this.listeners[e]=[]),this.listeners[e].indexOf(t)===-1&&this.listeners[e].push(t)},this.removeEventListener=function(e,t){if(this.listeners[e]===void 0)return;let s=[];this.listeners[e].forEach(function(r){r!==t&&s.push(r)}),s.length===0?delete this.listeners[e]:this.listeners[e]=s},this.dispatchEvent=function(e){if(!e)return!0;this.debug&&console.debug(e),e.source=this;let t="on"+e.type;return this.hasOwnProperty(t)&&(this[t].call(this,e),e.defaultPrevented)?!1:this.listeners[e.type]?this.listeners[e.type].every(function(s){return s(e),!e.defaultPrevented}):!0},this._markClosed=function(){if(this.xhr=null,this.progress=0,this.chunk="",this._setReadyState(d.CLOSED),this.autoReconnect){if(this.maxRetries!==null&&this.retryCount>=this.maxRetries){this.debug&&console.debug(`SSE max retries (${this.maxRetries}) reached, stopping reconnection attempts`),this.autoReconnect=!1,this.close();return}this.reconnectTimer&&clearTimeout(this.reconnectTimer),this.debug&&console.debug(`SSE will attempt to reconnect in ${this.reconnectDelay}ms (attempt ${this.retryCount+1}${this.maxRetries?"/"+this.maxRetries:""})`),this.reconnectTimer=setTimeout(()=>{this.reconnectTimer=null,this.retryCount++,this.stream()},this.reconnectDelay)}},this._setReadyState=function(e){let t=new CustomEvent("readystatechange");t.readyState=e,this.readyState=e,this.dispatchEvent(t)},this._onStreamFailure=function(e){let t=new CustomEvent("error");t.responseCode=e.currentTarget.status,t.data=e.currentTarget.response,this.dispatchEvent(t),this._markClosed()},this._onStreamAbort=function(){this.dispatchEvent(new CustomEvent("abort")),this._markClosed()},this._onStreamProgress=function(e){if(!this.xhr)return;if(this.xhr.status<200||this.xhr.status>=300){this._onStreamFailure(e);return}this.retryCount=0;let t=this.xhr.responseText.substring(this.progress);this.progress+=t.length;let s=(this.chunk+t).split(/(\r\n\r\n|\r\r|\n\n)/g),r=s.pop();s.forEach(function(i){i.trim().length>0&&this.dispatchEvent(this._parseEventChunk(i))}.bind(this)),this.chunk=r},this._onStreamLoaded=function(e){this._onStreamProgress(e),this.dispatchEvent(this._parseEventChunk(this.chunk)),this.chunk="",this._markClosed()},this._parseEventChunk=function(e){if(!e||e.length===0)return null;this.debug&&console.debug(e);let t={id:null,retry:null,data:null,event:null};if(e.split(/\n|\r\n|\r/).forEach(function(r){let i=r.indexOf(this.FIELD_SEPARATOR),a,h;if(i>0){let u=r[i+1]===" "?2:1;a=r.substring(0,i),h=r.substring(i+u)}else if(i<0)a=r,h="";else return;a in t&&(a==="data"&&t[a]!==null?t.data+=`
`+h:t[a]=h)}.bind(this)),t.data===null)return null;t.id!==null&&(this.lastEventId=t.id);let s=new CustomEvent(t.event||"message");return s.id=t.id,s.data=t.data||"",s.lastEventId=this.lastEventId,s},this._onReadyStateChange=function(){if(this.xhr&&this.xhr.readyState===XMLHttpRequest.HEADERS_RECEIVED){let e={},t=this.xhr.getAllResponseHeaders().trim().split(`\r
`);for(let r of t){let[i,...a]=r.split(":"),h=a.join(":").trim();e[i.trim().toLowerCase()]=e[i.trim().toLowerCase()]||[],e[i.trim().toLowerCase()].push(h)}let s=new CustomEvent("open");s.responseCode=this.xhr.status,s.headers=e,this.dispatchEvent(s),this._setReadyState(d.OPEN)}},this.stream=function(){if(!this.xhr){this._setReadyState(d.CONNECTING),this.xhr=new XMLHttpRequest,this.xhr.addEventListener("progress",this._onStreamProgress.bind(this)),this.xhr.addEventListener("load",this._onStreamLoaded.bind(this)),this.xhr.addEventListener("readystatechange",this._onReadyStateChange.bind(this)),this.xhr.addEventListener("error",this._onStreamFailure.bind(this)),this.xhr.addEventListener("abort",this._onStreamAbort.bind(this)),this.xhr.open(this.method,this.url);for(let e in this.headers)this.xhr.setRequestHeader(e,this.headers[e]);this.useLastEventId&&this.lastEventId.length>0&&this.xhr.setRequestHeader("Last-Event-ID",this.lastEventId),this.xhr.withCredentials=this.withCredentials,this.xhr.send(this.payload)}},this.close=function(){this.readyState!==d.CLOSED&&(this.reconnectTimer&&(clearTimeout(this.reconnectTimer),this.reconnectTimer=null),this.autoReconnect=!1,this.xhr.abort())},(n.start===void 0||n.start)&&this.stream()};d.INITIALIZING=-1;d.CONNECTING=0;d.OPEN=1;d.CLOSED=2;typeof exports<"u"&&(exports.SSE=d);function j(o="http://localhost:5984",n,e){let t=`${o}/${n}`;return new R(s=>{let r=new d(`${t}/_changes?feed=eventsource&include_docs=false&since=now&heartbeat=3000`,{headers:{Authorization:e},withCredentials:!0,autoReconnect:!0,reconnectDelay:1e3,maxRetries:null,useLastEventId:!0,start:!1});return r.onmessage=i=>{try{let{data:a}=i;if(a!==`
`){let h=JSON.parse(a);s.next(h)}}catch(a){console.error("Error parsing CouchDB event data:",a)}},r.onerror=i=>{console.error("CouchDB EventSource error:",i),s.error(i),r.close()},r.stream(),console.log("CouchDB event listener started"),()=>{r.close(),console.log("CouchDB event listener closed")}}).pipe(T(5))}var C=`Basic ${btoa("admin:password")}`,p={Authorization:C,"Content-Type":"application/json"};async function D(o=5,n=1e3){let t=await import("./dist-QVLQ4CZR.js"),s=`${g}/relations/_bulk_docs`;for(let r=0;r<=o;r+=1){let i=[];for(let a=0;a<n;a+=1){let h=await A(t.faker);i.push(S(y({},h),{_id:h.id}))}await fetch(s,{method:"POST",headers:p,body:JSON.stringify({docs:i})})}}async function F(){await E("name"),await E("username"),await E("email"),console.log("Indexes created")}async function E(o){let n=`${g}/relations/_index`,e={index:{fields:[o]},name:o,type:"json",ddoc:"fieldIndex-"+o},t=await fetch(n,{method:"POST",headers:p,body:JSON.stringify(e)});if(!t.ok)throw new Error(`Error creating index: ${t.statusText}`);let s=await t.json();return console.log("Index created",s),s}var H=(()=>{class o{constructor(){this.shown=c(!1),this.message=c(""),this.template=c(void 0),this.title=c("Sorry, something went wrong"),this.type=c("error"),this.dismissButtonText=c("dismiss"),this.showTemplate=e=>{this.template.set(e),this.shown.set(!0)},this.show=({message:e="",title:t=this.title(),type:s=this.type(),dismissButtonText:r=this.dismissButtonText()})=>{this.message.set(e),t&&this.title.set(t),this.type.set(s),this.dismissButtonText.set(r),this.shown.set(!0)},this.close=()=>{this.shown.set(!1),this.template.set(void 0),this.message.set(""),this.type.set("error"),this.title.set("Sorry, something went wrong"),this.dismissButtonText.set("dismiss")},this.isShown=()=>this.shown()}static{this.\u0275fac=function(t){return new(t||o)}}static{this.\u0275prov=v({token:o,factory:o.\u0275fac,providedIn:"root"})}}return o})();var G=o=>{try{return o()}catch(n){let e=n;if(e?.message?.startsWith("NG0950"))return;throw e}};var g="http://kapow:5984",l=U({headers:p}),ge=(()=>{class o{#e;#a;#s;#i;#h;#n;#o;#r;#t;constructor(){this.baseUrl=`${g}/relations`,this.idUrl=e=>`${this.baseUrl}/${e}`,this.#e=m(P),this.#a=m(k),this.#s=m(H),this.#i=m(B),this.#h=m(_),this.filter=c(""),this.#n=M(()=>`(?i)${this.filter()}`,{delay:250}),this.#o=c(0),this.sort=c("name"),this.order=c("asc"),this.#r=w(()=>({url:`${this.baseUrl}/_find?v=${this.#o()}`,method:"POST",body:{selector:{$or:[{name:{$regex:this.#n()}},{username:{$regex:this.#n()}},{email:{$regex:this.#n()}}]},fields:["id","_rev"],sort:[{[this.sort()]:this.order()}],limit:15},headers:p}),{defaultValue:[],parse:e=>(e?.docs??[]).map(t=>[t.id,t._rev])}),this.#t=this.#r.value,this.list=this.#t.asReadonly(),this.listIsLoading=this.#r.isLoading,this._DbError=L(async()=>{let e=this.#r.error();if(!e)return;let t=e.error?.reason;if(!t){console.error("Unknown error",e),this.#s.show({title:"CouchDB not found?",message:"This is a demo app, and it expects CouchDB to be running locally. Please check the console for more information."});return}if(t.startsWith("No index exists")){console.error("Index not found, creating it");try{await F().catch(s=>console.error("Error creating index",s)),this.#r.reload()}catch(s){console.error("Error creating index",s)}}if(t.startsWith("Database does not exist")){console.error("Database not found, creating it");try{await N(async()=>await this.#e.put(this.baseUrl,{},l)),await D(),this.#r.reload()}catch(s){console.error("Error creating database",s)}}console.error(e),this.#s.show({title:"CouchDB error?",message:"There is an unknown error with the database. Please check the console for more information."})}),this.create=async e=>{let t=this.idUrl(e.id);try{let s=await this.#e.put(t,e,l);return console.dir(s),this.#t.update(r=>[[e.id,""],...r].splice(0,50)),!0}catch(s){return console.error("Error creating user",s),!1}},this.read=(e,t=l)=>{let s=x(()=>G(e)??""),r=x(()=>{if(s())return y({url:this.idUrl(s())},t)});return w(r,{defaultValue:{id:s()}})},this.update=async e=>{let t=e.id,s=this.idUrl(t),r=await this.#e.get(s,l);if($(r,e))return{result:"noChange"};try{let{rev:i}=await this.#e.put(s,e,l);return r[this.sort()]!==e[this.sort()]?(console.log(`sort field changed from ${r[this.sort()]} to ${e[this.sort()]}`),this.#o.update(a=>a+1)):this.#t.update(a=>a.reduce((h,u)=>[...h,[u[0],u[0]===t?i:u[1]]],[])),{result:"ok",rev:i}}catch(i){let{error:{error:a,reason:h}}=i??{};if(console.log(i,a,h),h.startsWith("Document update conflict"))try{this.#i.purge(s);let u=b(r,e),f=await this.#e.get(s,l),W=b(r,f),q=O(f,u);return this.#s.show({title:"Sorry, we detected a conflict",message:"we have merged in the upstream change, please verify your edit, and submit your changes again"}),{result:"conflict",user:q}}catch{this.#s.show({title:"Sorry, but an unrecoverable error happened",message:"please reload your app"})}return{result:"error",error:i}}},this.delete=async e=>{let t=e.id,s=this.idUrl(t)+`?rev=${e._rev}`;try{await this.#e.delete(s,l)}catch(r){let{error:{error:i,reason:a}}=r??{};if(i==="not_found"&&a==="deleted")console.log("already deleted, ignore this log");else{this.#i.purge(s),this.#s.show({title:"The data was updated",message:"There was an update on the data you tried to delete. I have loaded the update into the view. Review, and try to delete again if still needed."});let{_rev:h}=await this.#e.get(s,l);return this.#t.update(u=>u.map(f=>f[0]===t?[f[0],h]:f)),!1}}return this.#t.update(r=>r.filter(i=>i[0]!==t)),!0},this.reFetch=async e=>{let t=this.idUrl(e);return I(this.#a.get(t,l))},this.info=async()=>{await D();let e=`${this.baseUrl}`;return this.#e.get(e,l)},setTimeout(()=>{let e=j(g,"relations",C).subscribe(t=>{if(this.#i.purge(this.idUrl(t.id)),t.deleted)this.#t.update(s=>s.filter(r=>r[0]!==t.id));else{let s=t.changes[0]?.rev??"";this.#t.update(r=>r.map(i=>i[0]===t.id?[i[0],s]:i))}});this.#h.onDestroy(()=>{e.unsubscribe()})},1e3)}static{this.\u0275fac=function(t){return new(t||o)}}static{this.\u0275prov=v({token:o,factory:o.\u0275fac})}}return o})();export{H as a,ge as b};
