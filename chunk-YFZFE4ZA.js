import{a as c}from"./chunk-ZDGDS7Z3.js";import{b as p,c as f}from"./chunk-5V4XLPRG.js";import{C as w,D as a,I as S,Jc as A,M as I,U as m,V as q,W as O,Z as D,aa as u,c as d,f as g,fa as h,h as v,i as b,l as y,pa as E,q as s,r as x,z as j}from"./chunk-YDUWCTK6.js";var C=(()=>{class r{constructor(){this.mqtt=import("./mqtt.esm-QZZS7UDG.js"),this.client=this.mqtt.then(e=>e.default.connectAsync("ws://10.0.0.100:1884")),this.baseTopic="zigbee2mqtt",this.messages$=new d(e=>{let t=(n,o)=>{try{e.next({topic:n,message:JSON.parse(o.toString())})}catch{e.next({topic:n,message:o.toString()})}};return this.client.then(n=>{console.log("start listening for MQTT messages"),n.on("message",t)}),()=>{this.client.then(n=>{n.off("message",t),n.end(),console.log("MQTT client disconnected")})}}).pipe(m({connector:()=>new g,resetOnComplete:!0})),this.activeTopics=new Map}listenFor(e){let t=this.client;if(typeof e!="string")return console.warn("listenFor expects a string topic, got",e),b;e=e.startsWith(this.baseTopic)?e:`${this.baseTopic}/${e}`;let n=this.activeTopics;if(n.has(e))return n.get(e);let o=this.messages$.pipe(a(({topic:i})=>Array.isArray(i)?i.includes(e):i===e),s(({message:i})=>i),S(100),I(c),D({error(){t.then(i=>i.unsubscribe(e)),n.delete(e),console.log("stopped listening due of error for",e)},complete(){t.then(i=>i.unsubscribe(e)),n.delete(e),console.log("stopped listening for",e)}}),m({connector:()=>new v(1),resetOnComplete:!0,resetOnRefCountZero:()=>j(1005)}));return this.activeTopics.set(e,o),t.then(i=>{i.subscribe([e])}),o}static{this.\u0275fac=function(t){return new(t||r)}}static{this.\u0275prov=u({token:r,factory:r.\u0275fac,providedIn:"root"})}}return r})();var G=(()=>{class r{constructor(){this.mqtt=h(C),this.injector=h(E),this.devices=p(this.mqtt.listenFor("bridge/devices"),{initialValue:[],debugName:"ZigbeeServiceDevices"}),this.getDeviceInfo=e=>A(()=>this.#e(e()),{equal:c}),this.getDeviceStatus=e=>f({params:()=>this.#e(e()),stream:({params:t})=>t&&t.friendly_name?this.mqtt.listenFor(`zigbee2mqtt/${t.friendly_name}`):w,injector:this.injector}),this.getStatus=e=>f({params:()=>N(typeof e=="string"?e:e()),stream:({params:t})=>this.mqtt.listenFor(t),injector:this.injector}),this.getMultipleStatuses=e=>f({params:()=>N(e()),stream:({params:t})=>!t||t.length===0?y([]):x(t.map(n=>this.mqtt.listenFor(n).pipe(O(null)))).pipe(s(n=>n.map((o,i)=>typeof o!="object"||o===null?{friendly_name:t[i],power:0,energy:0,current:0}:{friendly_name:t[i],power:o.power??0,energy:o.energy??0,current:o.current??0}))),injector:this.injector,equal:c}),this.#t=this.mqtt.listenFor("bridge/logging").pipe(a(e=>e&&typeof e.message=="string"&&["permit_join","zh:ember: [stack status] network","disabling joining new devices"].some(t=>e.message.toLowerCase().includes(t))),s(U),q(1)),this.joinAllowed=p(this.#t,{initialValue:!1}),this.publish=async(e,t)=>(typeof t!="string"&&(t=JSON.stringify(t)),(await this.mqtt.client).publishAsync(e,t)),this.#e=e=>this.devices().find(t=>t.ieee_address===e||t.friendly_name===e)}#t;#e;static{this.\u0275fac=function(t){return new(t||r)}}static{this.\u0275prov=u({token:r,factory:r.\u0275fac,providedIn:"root"})}}return r})();function U(r){let l=r.message?.toLowerCase();console.log({lowerLog:l});let e=l?.split("payload '");if(e&&e.length>1)try{let n=JSON.parse(e[1].split("'")[0])?.data?.time??0;return typeof n=="number"&&n>0}catch{return!1}return!!l.includes("open")}var N=r=>{if(!(Array.isArray(r)&&r.length===0)&&r!==null&&!(typeof r=="object"&&Object.keys(r).length===0)&&!(typeof r=="string"&&r.trim()==="")&&!(typeof r=="number"&&(isNaN(r)||r===0)))return r};export{C as a,G as b};
