import{a as B,b as A}from"./chunk-BVYHASPJ.js";import{a as U}from"./chunk-KONHSAQK.js";import{a as w}from"./chunk-MWBNYM5M.js";import{b as M}from"./chunk-7FH7DUVK.js";import{g as b,h as k,i as $,j as O,m as P}from"./chunk-FEAZLDTM.js";import{d as L,h as v}from"./chunk-BDIKAETI.js";import{Aa as N,Rc as p,S as T,aa as y,d as S,fa as f,p as I,qa as R,wa as c,za as _}from"./chunk-VNOCNMFG.js";import{a as g,b as C}from"./chunk-C6Q5SG76.js";var E="https://couchdb.eliasweb.nl",j={"Content-Type":"application/json",credentials:"include",mode:"cors"};async function D(n=5,o=1e3,e=E){let s=await import("./dist-ZINHZZQA.js"),r=`${e}/relations/_bulk_docs`;for(let i=0;i<=n;i+=1){let a=[];for(let h=0;h<o;h+=1){let d=await M(s.faker);a.push(C(g({},d),{_id:d.id}))}await fetch(r,{method:"POST",headers:j,body:JSON.stringify({docs:a})})}}async function F(n=E){await x("name",n),await x("username",n),await x("email",n),console.log("Indexes created")}async function x(n,o=E){let e=`${o}/relations/_index`,t={index:{fields:[n]},name:n,type:"json",ddoc:"fieldIndex-"+n},s=await fetch(e,{method:"POST",headers:j,body:JSON.stringify(t)});if(!s.ok)throw new Error(`Error creating index: ${s.statusText}`);let r=await s.json();return console.log("Index created",r),r}var H=(()=>{class n{constructor(){this.shown=c(!1),this.message=c(""),this.template=c(void 0),this.title=c("Sorry, something went wrong"),this.type=c("error"),this.dismissButtonText=c("dismiss"),this.active=new w,this.showTemplate=e=>{this.template.set(e),this.shown.set(!0)},this.show=({message:e="",title:t=this.title(),type:s=this.type(),dismissButtonText:r=this.dismissButtonText()})=>(this.message.set(e),t&&this.title.set(t),this.type.set(s),this.dismissButtonText.set(r),this.shown.set(!0),this.active=new w,this.active.promise),this.close=()=>{this.shown.set(!1),this.template.set(void 0),this.message.set(""),this.type.set("error"),this.title.set("Sorry, something went wrong"),this.dismissButtonText.set("dismiss"),this.active.resolve()},this.isShown=()=>this.shown()}static{this.\u0275fac=function(t){return new(t||n)}}static{this.\u0275prov=y({token:n,factory:n.\u0275fac,providedIn:"root"})}}return n})();var G=n=>{try{return n()}catch(o){let e=o;if(e?.message?.startsWith("NG0950"))return;throw e}};var l=function(n,o){if(!(this instanceof l))return new l(n,o);this.url=n,o=o||{},this.headers=o.headers||{},this.payload=o.payload!==void 0?o.payload:"",this.method=o.method||this.payload&&"POST"||"GET",this.withCredentials=!!o.withCredentials,this.debug=!!o.debug,this.autoReconnect=o.autoReconnect!==void 0?o.autoReconnect:!1,this.reconnectDelay=o.reconnectDelay!==void 0?o.reconnectDelay:3e3,this.maxRetries=o.maxRetries!==void 0?o.maxRetries:null,this.retryCount=0,this.reconnectTimer=null,this.useLastEventId=o.useLastEventId!==void 0?o.useLastEventId:!0,this.FIELD_SEPARATOR=":",this.listeners={},this.xhr=null,this.readyState=l.INITIALIZING,this.progress=0,this.chunk="",this.lastEventId="",this._hasParsedBom=!1,this.addEventListener=function(e,t){this.listeners[e]===void 0&&(this.listeners[e]=[]),this.listeners[e].indexOf(t)===-1&&this.listeners[e].push(t)},this.removeEventListener=function(e,t){if(this.listeners[e]===void 0)return;let s=[];this.listeners[e].forEach(function(r){r!==t&&s.push(r)}),s.length===0?delete this.listeners[e]:this.listeners[e]=s},this.dispatchEvent=function(e){if(!e)return!0;this.debug&&console.debug(e),e.source=this;let t="on"+e.type;return this.hasOwnProperty(t)&&(this[t].call(this,e),e.defaultPrevented)?!1:this.listeners[e.type]?this.listeners[e.type].every(function(s){return s(e),!e.defaultPrevented}):!0},this._markClosed=function(){if(this.xhr=null,this.progress=0,this.chunk="",this._setReadyState(l.CLOSED),this.autoReconnect){if(this.maxRetries!==null&&this.retryCount>=this.maxRetries){this.debug&&console.debug(`SSE max retries (${this.maxRetries}) reached, stopping reconnection attempts`),this.autoReconnect=!1,this.close();return}this.reconnectTimer&&clearTimeout(this.reconnectTimer),this.debug&&console.debug(`SSE will attempt to reconnect in ${this.reconnectDelay}ms (attempt ${this.retryCount+1}${this.maxRetries?"/"+this.maxRetries:""})`),this.reconnectTimer=setTimeout(()=>{this.reconnectTimer=null,this.retryCount++,this.stream()},this.reconnectDelay)}},this._setReadyState=function(e){let t=new CustomEvent("readystatechange");t.readyState=e,this.readyState=e,this.dispatchEvent(t)},this._onStreamFailure=function(e){let t=new CustomEvent("error");t.responseCode=e.currentTarget.status,t.data=e.currentTarget.response,this.dispatchEvent(t),this._markClosed()},this._onStreamAbort=function(){this.dispatchEvent(new CustomEvent("abort")),this._markClosed()},this._onStreamProgress=function(e){if(!this.xhr)return;if(this.xhr.status<200||this.xhr.status>=300){this._onStreamFailure(e);return}this.retryCount=0;let t=this.xhr.responseText.substring(this.progress);this.progress+=t.length,!this._hasParsedBom&&this.chunk.length===0&&(t.charCodeAt(0)===65279&&(t=t.substring(1)),this._hasParsedBom=!0);let s=(this.chunk+t).split(/(\r\n\r\n|\r\r|\n\n)/g),r=s.pop();s.forEach(function(i){i.trim().length>0&&this.dispatchEvent(this._parseEventChunk(i))}.bind(this)),this.chunk=r},this._onStreamLoaded=function(e){this._onStreamProgress(e),this.dispatchEvent(this._parseEventChunk(this.chunk)),this.chunk="",this._markClosed()},this._parseEventChunk=function(e){if(!e||e.length===0)return null;this.debug&&console.debug(e);let t={id:null,retry:null,data:null,event:null};if(e.split(/\n|\r\n|\r/).forEach(function(r){let i=r.indexOf(this.FIELD_SEPARATOR),a,h;if(i>0){let d=r[i+1]===" "?2:1;a=r.substring(0,i),h=r.substring(i+d)}else if(i<0)a=r,h="";else return;a in t&&(a==="data"&&t[a]!==null?t.data+=`
`+h:t[a]=h)}.bind(this)),t.id!==null&&t.id.indexOf("\0")===-1&&(this.lastEventId=t.id),t.retry!==null&&/^[0-9]+$/.test(t.retry)&&(this.reconnectDelay=parseInt(t.retry,10)),t.data===null)return null;let s=new CustomEvent(t.event||"message");return s.id=t.id,s.data=t.data||"",s.lastEventId=this.lastEventId,s},this._onReadyStateChange=function(){if(this.xhr&&this.xhr.readyState===XMLHttpRequest.HEADERS_RECEIVED){let e={},t=this.xhr.getAllResponseHeaders().trim().split(`\r
`);for(let r of t){let[i,...a]=r.split(":"),h=a.join(":").trim();e[i.trim().toLowerCase()]=e[i.trim().toLowerCase()]||[],e[i.trim().toLowerCase()].push(h)}let s=new CustomEvent("open");s.responseCode=this.xhr.status,s.headers=e,this.dispatchEvent(s),this._setReadyState(l.OPEN)}},this.stream=function(){if(!this.xhr){this._setReadyState(l.CONNECTING),this.xhr=new XMLHttpRequest,this.xhr.addEventListener("progress",this._onStreamProgress.bind(this)),this.xhr.addEventListener("load",this._onStreamLoaded.bind(this)),this.xhr.addEventListener("readystatechange",this._onReadyStateChange.bind(this)),this.xhr.addEventListener("error",this._onStreamFailure.bind(this)),this.xhr.addEventListener("abort",this._onStreamAbort.bind(this)),this.xhr.open(this.method,this.url);for(let e in this.headers)this.xhr.setRequestHeader(e,this.headers[e]);this.useLastEventId&&this.lastEventId.length>0&&this.xhr.setRequestHeader("Last-Event-ID",this.lastEventId),this.xhr.withCredentials=this.withCredentials,this.xhr.send(this.payload)}},this.close=function(){this.reconnectTimer&&(clearTimeout(this.reconnectTimer),this.reconnectTimer=null),this.autoReconnect=!1,this.xhr&&this.xhr.abort()},(o.start===void 0||o.start)&&this.stream()};l.INITIALIZING=-1;l.CONNECTING=0;l.OPEN=1;l.CLOSED=2;function q(n="http://localhost:5984",o){let e=`${n}/${o}`;return new S(t=>{let s=new l(`${e}/_changes?feed=eventsource&include_docs=false&since=now&heartbeat=3000`,{withCredentials:!0,autoReconnect:!0,reconnectDelay:1e3,maxRetries:null,useLastEventId:!0,start:!1});return s.onmessage=r=>{try{let{data:i}=r;if(i!==`
`){let a=JSON.parse(i);t.next(a)}}catch(i){console.error("Error parsing CouchDB event data:",i)}},s.onerror=r=>{console.error("CouchDB EventSource error:",r),t.error(r),s.close()},s.stream(),console.log("CouchDB event listener started"),()=>{s.close(),console.log("CouchDB event listener closed")}}).pipe(T(5))}var u=g({},B({credentials:"include",mode:"cors"})),ye=(()=>{class n{#e;#a;#t;#i;#h;#n;#o;#r;#s;constructor(){this.user=f(U).user,this.base=p(()=>`https://${this.user()===void 0?"demodb":"couchdb"}.eliasweb.nl`),this.baseUrl=p(()=>`${this.base()}/relations`),this.idUrl=e=>`${this.baseUrl()}/${e}`,this.#e=f(O),this.#a=f(L),this.#t=f(H),this.#i=f(A),this.#h=f(R),this.filter=c(""),this.#n=P(()=>`(?i)${this.filter()}`,{delay:250}),this.#o=c(0),this.sort=c("name"),this.order=c("asc"),this.#r=v(()=>({url:`${this.baseUrl()}/_find?v=${this.#o()}`,method:"POST",body:{selector:{$or:[{name:{$regex:this.#n()}},{username:{$regex:this.#n()}},{email:{$regex:this.#n()}}]},fields:["id","_rev"],sort:[{[this.sort()]:this.order()}],limit:15},credentials:"include",mode:"cors"}),{defaultValue:[],parse:e=>(e?.docs??[]).map(t=>[t.id,t._rev])}),this.#s=this.#r.value,this.list=this.#s.asReadonly(),this.listIsLoading=this.#r.isLoading,this._DbError=_(async()=>{let e=this.#r.error();if(!e)return;let t=e.error?.reason;if(!t){console.error("Unknown error",e),this.#t.show({title:"CouchDB not found?",message:"This is a demo app, and it expects CouchDB to be running locally. Please check the console for more information."});return}if(t.startsWith("No index exists")){console.error("Index not found, creating it");try{await F().catch(s=>console.error("Error creating index",s)),this.#r.reload()}catch(s){console.error("Error creating index",s)}}if(t.startsWith("Database does not exist")){console.error("Database not found, creating it");try{await N(async()=>await this.#e.put(this.baseUrl(),{},u)),await D(),this.#r.reload()}catch(s){console.error("Error creating database",s)}}console.error(e),this.#t.show({title:"CouchDB error?",message:"There is an unknown error with the database. Please check the console for more information."})}),this.create=async e=>{let t=this.idUrl(e.id);try{let s=await this.#e.put(t,e,u);return console.dir(s),this.#s.update(r=>[[e.id,""],...r].splice(0,50)),!0}catch(s){let{error:{error:r,reason:i}}=s??{};return r==="forbidden"?(await this.#t.show({title:"You are not allowed to add a user",message:"This is likely because you are on the demo account, which has no write access"}),!1):(console.error("Error creating user",s),!1)}},this.read=(e,t=u)=>{let s=p(()=>G(e)??""),r=p(()=>{if(s())return g({url:this.idUrl(s())},t)});return v(r,{defaultValue:{id:s()}})},this.update=async e=>{let t=e.id,s=this.idUrl(t),r=await this.#e.get(s,u);if(k(r,e))return{result:"noChange"};try{let{rev:i}=await this.#e.put(s,e,u);return r[this.sort()]!==e[this.sort()]?(console.log(`sort field changed from ${r[this.sort()]} to ${e[this.sort()]}`),this.#o.update(a=>a+1)):this.#s.update(a=>a.reduce((h,d)=>[...h,[d[0],d[0]===t?i:d[1]]],[])),{result:"ok",rev:i}}catch(i){let{error:{error:a,reason:h}}=i??{};if(a==="forbidden")return await this.#t.show({title:"You are not allowed to update this data",message:"This is likely because you are on the demo account, which has no write access"}),{result:"error",error:"forbidden"};if(h.startsWith("Document update conflict"))try{this.#i.purge(s);let d=b(r,e),m=await this.#e.get(s,u),J=b(r,m),V=$(m,d);return this.#t.show({title:"Sorry, we detected a conflict",message:"we have merged in the upstream change, please verify your edit, and submit your changes again"}),{result:"conflict",user:V}}catch{this.#t.show({title:"Sorry, but an unrecoverable error happened",message:"please reload your app"})}return{result:"error",error:i}}},this.delete=async e=>{let t=e.id,s=this.idUrl(t)+`?rev=${e._rev}`;try{await this.#e.delete(s,u)}catch(r){let{error:{error:i,reason:a}}=r??{};if(i==="forbidden")return this.#t.show({title:"You are not allowed to delete this data",message:"This is likely because you are on the demo account, which has no write access"}),!1;if(i==="not_found"&&a==="deleted")console.log("already deleted, ignore this log");else{this.#i.purge(s),this.#t.show({title:"The data was updated",message:"There was an update on the data you tried to delete. I have loaded the update into the view. Review, and try to delete again if still needed."});let{_rev:h}=await this.#e.get(s,u);return this.#s.update(d=>d.map(m=>m[0]===t?[m[0],h]:m)),!1}}return this.#s.update(r=>r.filter(i=>i[0]!==t)),!0},this.reFetch=async e=>{let t=this.idUrl(e);return I(this.#a.get(t,u))},this.info=async()=>{await D();let e=`${this.baseUrl}`;return this.#e.get(e,u)},setTimeout(()=>{let e=q(this.base(),"relations").subscribe(t=>{if(this.#i.purge(this.idUrl(t.id)),t.deleted)this.#s.update(s=>s.filter(r=>r[0]!==t.id));else{let s=t.changes[0]?.rev??"";this.#s.update(r=>r.map(i=>i[0]===t.id?[i[0],s]:i))}});this.#h.onDestroy(()=>{e.unsubscribe()})},2e3)}static{this.\u0275fac=function(t){return new(t||n)}}static{this.\u0275prov=y({token:n,factory:n.\u0275fac})}}return n})();export{H as a,ye as b};
