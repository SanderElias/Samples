import{b as N}from"./chunk-HVNCIVHL.js";import"./chunk-YCUAPCM2.js";import"./chunk-PHY3EWUA.js";import"./chunk-MWBNYM5M.js";import"./chunk-VGHCC5VF.js";import"./chunk-OZD4UVZE.js";import{b as w,d as q,f as F,g as f}from"./chunk-L5O72GTG.js";import"./chunk-N6XXPM5M.js";import"./chunk-YXYYIOOJ.js";import{$b as o,Rc as s,Sc as u,Xc as _,Yc as c,Zc as M,_b as n,ac as m,ec as D,fa as p,hd as C,jc as y,ka as h,la as E,rc as S,sb as v,sc as x,xc as r,za as b}from"./chunk-XM6TYFHN.js";import{a as g}from"./chunk-C6Q5SG76.js";var O=["form"],T=(()=>{class l{constructor(){this.id=c.required(),this.rev=c.required(),this.done=_(),this.form=M("form"),this.rs=p(N),this.relation=this.rs.read(this.id),this.flatData=u({source:()=>this.relation.value(),computation:i=>q(i??{})}),this.fields=u({source:this.flatData,computation:i=>Object.keys(i)}),this.originalData=s(()=>w(this.relation.value()??{})),this.currentFormData=s(()=>{let i=this.form()?.nativeElement;if(!i)return{};let e=g({},this.flatData());for(let t of this.fields())if(i[t]){let a=typeof e[t];a==="string"&&(e[t]=i[t].value),a==="number"&&(e[t]=Number(i[t].value)),a==="boolean"&&(e[t]=i[t].checked)}return F(e)}),this._r=C(async()=>{let i=this.rev(),e=this.relation.value()?._rev;if(console.log({rev:i,currentRev:e}),i&&e&&i!==e){let t=await this.rs.reFetch(this.id());console.log("The relation has been updated elsewhere. Please reload the form to get the latest data.");let a=f(this.originalData(),this.currentFormData()),d=f(this.originalData(),t);console.log("Remote changes:"),console.dir(d),console.log("Your unsaved changes:"),console.dir(a)}}),this._=b(()=>{let i=this.flatData(),e=this.form()?.nativeElement;if(!(!i||!e))for(let[t,a]of Object.entries(i))e[t]&&(e[t].value=a)})}async submit(i){i.preventDefault();let e=this.currentFormData(),{result:t,user:a,error:d}=await this.rs.update(e);if(t==="conflict"&&(console.log("Conflict detected, please reload the user data"),this.relation.value.set(a)),t==="error"){if(d==="forbidden")return this.done.emit();console.log("Error updating the user"),console.dir(d)}(t==="ok"||t==="noChange")&&(console.log("User updated successfully"),this.relation.reload(),this.done.emit())}static{this.\u0275fac=function(e){return new(e||l)}}static{this.\u0275cmp=v({type:l,selectors:[["relation-form"]],viewQuery:function(e,t){e&1&&S(t.form,O,5),e&2&&x()},inputs:{id:[1,"id"],rev:[1,"rev"]},outputs:{done:"done"},decls:37,vars:0,consts:[["form",""],[3,"submit"],["for","name"],["id","name","name","name","required",""],["for","username"],["id","username","name","username","required",""],["for","email"],["id","email","name","email","required","","type","email"],["for","street"],["id","street","name","address.street","required",""],["for","suite"],["id","suite","name","address.suite"],["for","city"],["id","city","name","address.city","required",""],["for","zipcode"],["id","zipcode","name","address.zipcode","required",""],["for","lat"],["id","lat","name","address.geo.lat","required","","min","-90","max","90","type","number","step","0.0001"],["for","lng"],["id","lng","name","address.geo.lng","required","","min","-180","max","180","type","number","step","0.0001"]],template:function(e,t){if(e&1){let a=D();n(0,"form",1,0),y("submit",function(R){return h(a),E(t.submit(R))}),n(2,"label",2),r(3,"Name"),o(),m(4,"input",3),n(5,"label",4),r(6,"Username"),o(),m(7,"input",5),n(8,"label",6),r(9,"Email"),o(),m(10,"input",7),n(11,"fieldset")(12,"legend"),r(13,"Address"),o(),n(14,"label",8),r(15,"Street"),o(),m(16,"input",9),n(17,"label",10),r(18,"Suite"),o(),m(19,"input",11),n(20,"label",12),r(21,"City"),o(),m(22,"input",13),n(23,"label",14),r(24,"Zipcode"),o(),m(25,"input",15),n(26,"fieldset")(27,"legend"),r(28,"Geo"),o(),n(29,"label",16),r(30,"Latitude"),o(),m(31,"input",17),n(32,"label",18),r(33,"Longitude"),o(),m(34,"input",19),o()(),n(35,"button"),r(36,"Submit"),o()()}},styles:['form[_ngcontent-%COMP%], fieldset[_ngcontent-%COMP%]{display:flex;flex-direction:column}input[_ngcontent-%COMP%]{margin-bottom:1rem}label[_ngcontent-%COMP%]:has(+input[required]):after{display:inline;content:"*";color:orange}input[_ngcontent-%COMP%]:last-child{margin-bottom:0}']})}}return l})();export{T as RelationForm};
