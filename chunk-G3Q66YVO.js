import{$ as x,C as D,D as C,E as h,F as m,G as d,J as P,M as v,U as u,W as j,Y as M,i as w,k as l,l as f,q as o,s as R,u as y,v as S}from"./chunk-3AXU7JV2.js";import{a as p,b as g}from"./chunk-DAQOROHW.js";function b(i){return new Promise((a,t)=>{i.oncomplete=i.onsuccess=()=>a(i.result),i.onabort=i.onerror=()=>t(i.error)})}function U(i,a){let t,e=()=>{if(t)return t;let n=indexedDB.open(i);return n.onupgradeneeded=()=>n.result.createObjectStore(a),t=b(n),t.then(r=>{r.onclose=()=>t=void 0},()=>{}),t};return(n,r)=>e().then(c=>r(c.transaction(a,n).objectStore(a)))}var A;function $(){return A||(A=U("keyval-store","keyval")),A}function I(i,a=$()){return a("readonly",t=>b(t.get(i)))}function k(i,a,t=$()){return t("readwrite",e=>(e.put(a,i),b(e.transaction)))}var s,B="sample-cache",E=!1;async function K(){try{if(s)return s;var i=await I(B);return s=i?new Map([...i]):new Map,s}catch{return s=new Map,E=!0,s}}function L(i,a){s.set(i,a),!E&&k(B,s)}function T(i){return s.has(i)}function H(i){return s.get(i)}var _=(()=>{class i{getAllPagedData(t){return l(this.load(`${t}`)).pipe(v(e=>e.next?this.load(e.next):w))}constructor(){this.baseUrl="https://swapi.dev/api/",this.swapiRoot={},this.load=async t=>{if(t=F(t),await K(),!T(t)){let e=await fetch(t).then(n=>n.json()).catch(n=>{});await L(t,e)}return H(t)},this.swapiRoot$=l(this.load(this.baseUrl)).pipe(M(t=>this.swapiRoot=t),u(1)),this.swPeople$=l(this.load(`${this.baseUrl}people/`)).pipe(v(t=>t.next?this.load(t.next):w),o(t=>t.results),h((t,e)=>t.concat(e),[]),o(t=>t.map(e=>g(p({},e),{date:W(),id:e.url}))),u(1)),this.findById=t=>this.swPeople$.pipe(o(e=>e[t]),D(Boolean),P(1)),this.swFilms$=l(this.load(`${this.baseUrl}films/`)).pipe(u(1)),this.findFilmByUrl=t=>this.get(t),this.getRandomPerson=(t=1)=>l(Array.from({length:t})).pipe(d(()=>this.swPeople$.pipe(o(e=>{let n=Math.floor(Math.random()*e.length);return e[n]}),R(e=>S(...e.films.map(n=>this.findFilmByUrl(n))).pipe(m(),o(n=>g(p({},e),{films:n}))))))),this.findIn=(t,e)=>this.getAllRows(t).pipe(o(n=>n.find(r=>(r.name||r.title||"").toLowerCase().includes(e.toLowerCase().trim())))),this.getSetNames=t=>this.getAllRows(t).pipe(o(e=>e.map(n=>n.name||n.title||""))),this.findWithName=t=>this.findIn("people",t),this.loadData().subscribe()}get(t){let e=Object.values(this.swapiRoot).find(n=>t.toLowerCase().includes(n.toLowerCase()));return e?this.getAllPagedData(e).pipe(h((n,r)=>n.concat(r.results),[]),o(n=>n.find(r=>r.url===t))):l(this.load(t))}loadData(){return this.swapiRoot$.pipe(M(t=>this.swapiRoot=t),d(t=>Object.values(t||{}).map(e=>this.getAllPagedData(e))),y(),m(),u(1))}enrich(t){let e=n=>{let r=t[n];return Array.isArray(r)&&r.length>0?l(r).pipe(d(c=>this.get(c)),m(),o(c=>({[n]:c}))):typeof r=="string"?(this.detectSet(r)?this.get(r):f(r)).pipe(o(O=>({[n]:O}))):f(r).pipe(o(c=>({[n]:c})))};return this.swapiRoot$.pipe(d(n=>Object.keys(t).map(e)),y(),h((n,r)=>p(p({},n),r),{}),C(n=>(console.warn(n),f({}))))}getAllRows(t){return this.swapiRoot$.pipe(j(()=>this.getAllPagedData(F(this.swapiRoot[t]))),o(e=>e.results),h((e,n)=>e.concat(n),[]),u(1))}detectSet(t){if(typeof t=="string"){let e=Object.entries(this.swapiRoot).find(([n,r])=>t.includes(r));return e&&e[0]}}static{this.\u0275fac=function(e){return new(e||i)}}static{this.\u0275prov=x({token:i,factory:i.\u0275fac,providedIn:"root"})}}return i})();function W(){let i=Math.ceil(Math.random()*1e3)+1e3,a=Math.floor(Math.random()*12),t=Math.ceil(Math.random()*27);return new Date(i,a,t,12,0)}function F(i){return i.split("http:").join("https:")}export{K as a,L as b,T as c,H as d,_ as e};
